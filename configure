#!/bin/bash

#
# Figure out selected MPI vendor and version
# Check for cuda version
# Figure out how to control affinity.   Look for gnu sched library
# Determine platform
# if x85 platform, then cpuid is available.
#

# Location to install
prefix=

# Figure out which mpi we are using
mpidef=""
mpitype=MPIUNKNOWN
mpiver=unknown
mpidir=

mpicc="mpicc -std=c99"
mpicxx="mpic++ -std=c++14"

spawn_envprop="env"  # for propagation of current value
spawn_envval="env-val" # for setting value

if [[ ${CRAY_MPICH_DIR}x == x ]]
then
	# Check for openmpi
	if [[ $(type -P ompi_info) ]]
	then
		v=`ompi_info --version | head -1 | sed "s/.* //"`
		if [[ ${v:0:2} == "v4" ]]
		then
			mpitype=OPENMPI4
			mpidef="-DOPENMPI4=1"
			mpiver="OpenMpi-$v"
			spawn_envval="env"  # older openmpi uses "env" for both
		elif [[ ${v:0:2} == "v5" ]]
		then
			mpitype=OPENMPI5
			mpidef="-DOPENMPI5=1"
			mpiver="OpenMpi-$v"
		else
			echo "Unknown OpenMPI version"
			exit 1
		fi
		mpidir=`which ompi_info`
		mpidir=`dirname $mpidir`
		mpidir=`dirname $mpidir`
	elif [[ -e ${MPI_DIR}/lib64/pkgconfig/mvapich2-gdr.pc ]]
	then
		mpitype=MVAPICH2-GDR
		mpidef="-DMVAPICH2=1 -DMVAPICH2_GDR=1"
		mpiver="mvapich2-gdr-2.3.7"
		spawn_envval="env"  # 2.3.7 still uses "env"
	fi
else
	echo "Found cray-mpich"
	echo "Need to verify dpm features are enabled"
	if [[ ${CRAY_ACCEL_TARGET}x == x ]]
	then
		echo "Please load module cray-accel-nvidia<compute> module for GTL library"
		echo "<compute> is the compute level of the GPU, like 80 on Perlmutter"
		exit 1
	fi
	mpidir=${CRAY_MPICH_DIR}
	mpitype=CRAYMPICH  # Todo: Use CRAYMPICHDPM if we find DPM features enabled
	mpidef="-DCRAYMPICH=1"
	v=`grep version= $CRAY_MPICH_DIR/lib/pkgconfig/mpich.pc`
	mpiver="${v:8:-1}"
	# cray uses funny names for their wrappers
	mpicc="cc -std=c99"
	mpicxx="CC -std=c++14"
fi


# process command line arguments
for arg in "$@"
do
    case "$arg" in
	--prefix=*) 
		prefix=${arg#*=}
		;;
	-h |  --help | --usage)
		echo ""
		echo "Usage:"
		echo "./configure --prefix=<installdir>"
		echo ""
		echo "Determine MPI vendor and version"
		echo "Determine if CUDA is available and version"
		echo "Determine how to control affinity for openmp threads (gnu sched_* functions)"
		echo "Determine platform: 'uname -m' output"
		echo ""
		echo "Configuration info is saved in config/make.conf and config/config.h"
		echo ""
		exit 0
		;;
    *)      
		echo unknown argument $arg
		;;
    esac
done

if [[ ${prefix}x == x ]]
then
	echo "Must specify --prefix=<installdir>"
	echo "   Will create <installdir>/{bin,lib,include,pylib} if missing and populate them"
	exit 1
fi

echo prefix=$prefix
machine=`uname -m`
os=`uname -o | sed -e "s+.*/++"`

if [ -d $MPI_DIR/lib64 ]
then
	mpilibdir="$mpidir/lib64"
else
	mpilibdir="$mpidir/lib"
fi

# Include file for Makefiles
cm=config/make.conf

# Include file for c/c++
ch=config/config.h


echo "# Make variables from configuration" > $cm
echo "PREFIX:=${prefix}" >> $cm
echo "${mpitype}:=1" >> $cm
echo "MPIVER:=${mpiver}" >> $cm
echo "MACHINE:=${machine}" >> $cm
echo "OS:=${os}" >> $cm
echo "MPICC=${mpicc}" >> $cm
echo "MPICXX=${mpicxx}" >> $cm
echo "MPI_DIR=${mpidir}" >> $cm
echo "MPI_LIB_DIR=${mpilibdir}" >> $cm
if [[ "${mpitype}" == "mvapich2-gdr-2.3.7" ]]
then
	# If we are using the GDR version, then links have to include cuda
	if [[ -n "${CRAY_CUDATOOLKIT_POST_LINK_OPTS}" ]]
	then
		# when using mvapich2
		echo "CFGLINKFLAGS=${CRAY_CUDATOOLKIT_POST_LINK_OPTS}" >> $cm
	else
		echo "Can't find cuda libs to link with, required for mvapich2-gdr"
		/bin/rm $cm
		exit 1
	fi
else
	echo "CFGLINKFLAGS=" >> $cm
fi

echo "// Configuration file for compilation" > $ch
echo "#define MPITYPE_${mpitype} 1" >> $ch
echo "#define MACHINE_${machine} 1" >> $ch
echo "#define OS_${os} 1" >> $ch
if [[ ${OS} == Darwin ]]
then
	if [[ ${MACHINE} == "x86_64" ]]
	then
		echo "#define USE_CPUID 1" >> $ch
	fi
else
	echo "#define USE_SCHED 1" >> $ch
fi
echo "#define JM_MPI_SPAWN_ENV_PROP \"${spawn_envprop}\""  >> $ch
echo "#define JM_MPI_SPAWN_ENV_VAL \"${spawn_envval}\""  >> $ch
